<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Kalita Server Demo</title>
		<script>
			function sendMessage(){
				var message = document.getElementById('userInput').value;
				document.getElementById('userInput').value = '';
				getAudio(message);
			}

			function showMessage(text) {
				document.getElementById('message').innerHTML = text;
			}

			function getAudio(text){
				fetch('http://localhost:8080/tts', {
					method: 'POST',
					body: text,
				})
				.then(response => response.blob())
				.then(audioBlob => {
					if(audioBlob instanceof Blob) {
						const file = new File([audioBlob], "voice.wav")
						audio = URL.createObjectURL(file)
						let sound = document.createElement('audio');
						sound.src = audio;
						sound.crossOrigin = 'anonymous';
						sound.play();
						//Error here
					}
				})
				.catch((error) => {
					console.error('Error:', error);
				});
			}

			//Old function with WebSocket
			function subscribeToWebSocket(){
				if('WebSocket' in window){
					socket = new WebSocket('ws://localhost:8080/kalitatts');
					socket.onopen = function(){
						showMessage('Connected to WebSocket.');
					};
					socket.onmessage = function(msg){
						if(msg.data instanceof Blob) {
							const file = new File([msg.data], "voice.wav")
							audio = URL.createObjectURL(file)
							let sound = document.createElement('audio');
							sound.src = audio;
							sound.play();
						}
						console.log(msg);
					};
					socket.onerror = function(msg){
						showMessage('Sorry but there was an error.');
						socket.close();
					};
					socket.onclose = function(){
						showMessage('Disconnected. Trying to reconnect...');
						setTimeout(subscribeToWebSocket(), 1000);
					};
				}
			}
		</script>
	</head>
	<body>
		<input id="userInput" type="text">
		<button onclick="javascript:sendMessage()">TTS</button>
		<div id="message"></div>
	</body>
</html>